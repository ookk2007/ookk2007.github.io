<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Google Maps + Firebase</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <style>
    html, body {
  margin: 0;
  height: 100%;
}

#map {
  height: 100%;
  width: 100%;
  position: absolute;
}

#top-bar {
  position: absolute;
  top: 0;
  left: 0;
  height: 50px;
  width: 100%;
  background-color: #FFF6C3;
  color: #5E4B43;
  display: flex;
  align-items: center;
  padding: 0;
  z-index: 10;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

#sidebar {
  position: absolute;
  background-color: white;
  top: 50px;
  left: 0;
  width: 270px;
  height: calc(100% - 50px);
  box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
  
  z-index: 11;
  overflow-y: auto;
  padding: 0;
  /* 완전히 숨기기 */
  transform: translateX(-100%);
  transition: transform 0.3s ease;
}

#sidebar.open {
  /* 원래 위치로 되돌리기 */
  transform: translateX(0);
}

#marker-list {
  list-style: none;
  padding: 0;
}

#marker-list li {
  padding: 10px;
  border-bottom: 1px solid #ddd;
  cursor: pointer;
  color: #5E4B43;
}

#marker-list li:hover {
  background-color: #FFF1B6;
}

#add-marker-button {
  background-color: #6a4e42;
  color: white;
  border: none;
  padding: 8px 12px;
  border-radius: 6px;
  cursor: pointer;
  width: 90%;
  margin-top: 10px;
  display: block;
  margin-left: auto;
  margin-right: auto;
}

#add-marker-button:hover {
  background-color: #e0dcd4;
}

button {
  background-color: #6a4e42;
  color: white;
  border: none;
  padding: 8px 12px;
  border-radius: 6px;
  cursor: pointer;
}

button:hover {
  background-color: #5a4239;
}

#top-bar button {
  margin-right: 15px;
  font-size: 24px;
  background: none;
  border: none;
  cursor: pointer;
  color: #5E4B43;
}

#top-bar span {
  font-family: "Playfair Display", serif;
  font-size: 24px;
  font-weight: 400;
  font-style: italic;
  margin-bottom: 0;
  margin-top: 0;
  display: flex;
  align-items: center;
  justify-content: center;
}

#marker-form {
  position: absolute;
  top: 50%;
  left: 50%;
  width: 350px;
  transform: translate(-50%, -50%);
  background: white;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.2);
  z-index: 20;

  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s ease, visibility 0.3s ease;
}

#marker-form.show {
  opacity: 1;
  visibility: visible;
}

#location-action-buttons {
  position: fixed;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%); /* 수평 가운데 정렬 */
  width: 100%;
  display: flex;
  justify-content: space-between; /* 버튼 간의 간격을 적당히 나눔 */
  z-index: 1000;
}

#location-action-buttons button {
  flex: 1;
  height: 60px;
  font-size: 18px;
  width: 49%;
  border: none;
  cursor: pointer;
}

#cancel-location-btn {
  background-color: #f44336;
  color: white;
}

#confirm-location-btn {
  background-color: #4CAF50;
  color: white;
}

    form {
      margin-top: 20px;
    }

    input,
    textarea {
      display: block;
      margin-bottom: 10px;
      width: 300px;
    }
  </style>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

</head>

<body>
   
  <div id="map"></div>
  <div id="top-bar">
    <button id="sidebar-toggle">☰</button>
    <span>Our Memorial Map</span>
  </div>
  <div id="sidebar">
    <ul id="marker-list"></ul>
    <button id="add-marker-button">마커 추가하기</button>
  </div>

  <form id="marker-form">
    <p></p>
    <input type="text" id="title" placeholder="제목" required />
    <input type="date" id="date" required />
    <input type="number" id="lat" placeholder="위도" step="any" style="display:none;" required readonly />
    <input type="number" id="lng" placeholder="경도" step="any" style="display:none;" required readonly />
    <div style="display: flex; align-items: center;">
      <button type="button" id="select-location-btn">위치 설정하기</button>
      <p id="location-confirm" style="display:none; margin-left: 10px;">위치 설정 완료!</p>
    </div>
    <p></p>
    <input type="file" id="image" accept="image/*" multiple required />
    <div id="thumbnails" style="display:flex; flex-wrap:wrap; margin-top:10px; gap:8px;"></div>
    <input type="hidden" id="coverIndex" value="0" />
    <p></p>
    <button type="submit">마커 추가</button>
  </form>

  <div id="location-action-buttons" style="display: none;">
    <button id="confirm-location-btn">확인</button>
    <button id="cancel-location-btn">취소</button>
  </div>

  <!-- Google Maps API (아래 YOUR_API_KEY 부분을 발급받은 키로 교체) -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCqVKfR9xms-BS1q_knVrC1Iu3pFB42EB0&callback=initMap&libraries=geometry"
    async defer></script>

  <script>
    // Firebase 초기화
    const firebaseConfig = {
      apiKey: "AIzaSyAX6bguazAfd6OnKArF9dr7EGa-vxOri9A",
      authDomain: "hyeok-and-ryang.firebaseapp.com",
      databaseURL: "https://hyeok-and-ryang-default-rtdb.asia-southeast1.firebasedatabase.app/",
      projectId: "hyeok-and-ryang",
      storageBucket: "gs://hyeok-and-ryang.firebasestorage.app",
      messagingSenderId: "627188156266",
      appId: "1:627188156266:web:224812f4d3bfd0e2a78713"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const storage = firebase.storage();

    let map;
    const overlays = [];
    let infoWindow;

    // 지도 초기화 함수 (Google API가 자동으로 호출함)
    window.initMap = function () {
      infoWindow = new google.maps.InfoWindow();

      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 36.5, lng: 127.8 }, // 서울
        zoom: 7,
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: false,
        zoomControl: false,
        cameraControl: false,
        gestureHandling: "greedy"
      });

      loadMarkers();

      map.addListener("zoom_changed", () => {
        const currentZoom = map.getZoom();
        overlays.forEach(o => o.updateSize(currentZoom));
      });

      setupLongPressListener();
    };

    // Firebase에서 마커 불러오기
    function loadMarkers() {
  db.ref("markers").orderByChild("date").once("value", (snapshot) => {
    const markerList = document.getElementById("marker-list");
    markerList.innerHTML = "";
    snapshot.forEach((child) => {
      const data = child.val();
      const key = child.key;
      const date = new Date(data.date);
      const today = new Date("2022-08-12");
      const diff = Math.ceil((date - today) / (1000 * 60 * 60 * 24));
      const dday = diff < 0 ? `D-${Math.abs(diff)}` : `D+${diff}`;
      addImageOverlay({ ...data, key });
      
      // 사이드바에 추가
      const li = document.createElement("li");
      li.innerHTML = `
        <span>${date.toISOString().slice(0, 10)} (${dday})</span><br>
        <b>${data.title}</b>
      `;
      li.addEventListener("click", () => {
        document.getElementById("sidebar").classList.remove("open");
        map.panTo(new google.maps.LatLng(data.lat, data.lng));
        infoWindow.close();
        infoWindow.setContent(`
  <div style="max-width:250px; overflow:hidden;">
    <h4 style="margin-bottom:8px;">${data.title}</h4>
    <div style="display:flex; overflow-x:auto; scroll-snap-type:x mandatory; -webkit-overflow-scrolling:touch;">
      ${(data.imageUrls || []).map(url => `
        <img src="${url}" style="
          flex: 0 0 100%; 
          max-width:100%; 
          height:auto;
          object-fit: contain;
          border-radius:8px; 
          margin-right:8px; 
          scroll-snap-align: start;" />
      `).join("")}
    </div>
  </div>
`);

        infoWindow.setPosition(new google.maps.LatLng(data.lat, data.lng));
        infoWindow.open(map);
      });
      markerList.appendChild(li);
    });
  });
}


    //Zoom 레벨에 따른 마커 크기 계산
    function getSizeForZoom(zoom) {
      const baseSize = 60; // 기준 줌 레벨에서의 크기
      const baseZoom = 10;
      const scale = Math.pow(1.2, zoom - baseZoom);
      return Math.max(20, Math.min(100, baseSize * scale)); // 최소/최대 크기 제한
    }


    // 오버레이 생성 함수
    function addImageOverlay({ lat, lng, imageUrls, title }) {
      const div = document.createElement("div");
      
      div.addEventListener("click", () => {
  // 기존에 열린 infoWindow를 닫고 새로 열기
  infoWindow.close(); // 기존 infoWindow 닫기

  const imagesHtml = imageUrls.map(url => `
    <img src="${url}" style="
      flex: 0 0 100%;
      max-width: 100%;
      height: auto;
      object-fit: contain;
      border-radius: 8px;
      scroll-snap-align: start;
      margin-right: 8px;
      background-color: #ffffff;
    " />
  `).join("");

  infoWindow.setContent(`
    <div style="max-width:250px; overflow:hidden;">
      <h4 style="margin-bottom:8px;">${title}</h4>
      <div style="
        display: flex;
        overflow-x: auto;
        scroll-snap-type: x mandatory;
        -webkit-overflow-scrolling: touch;
      ">
        ${imagesHtml}
      </div>
    </div>
  `);

  infoWindow.setPosition(new google.maps.LatLng(lat, lng));
  infoWindow.open(map);
});

      const overlay = new google.maps.OverlayView();

      overlay.onAdd = function () {
        div.style.position = "absolute";
        div.style.border = "2px solid white";
        div.style.borderRadius = "12px";
        div.style.boxShadow = "0 2px 6px rgba(0,0,0,0.3)";
        div.style.backgroundSize = "cover";
        div.style.backgroundImage = `url(${imageUrls})`;
        div.title = title;

        this.div = div;

        const panes = this.getPanes();
        panes.overlayImage.appendChild(div);
      };

      overlay.draw = function () {
        const projection = this.getProjection();
        const position = new google.maps.LatLng(lat, lng);
        const pixel = projection.fromLatLngToDivPixel(position);
        const zoom = map.getZoom();
        const size = getSizeForZoom(zoom);

        const div = this.div;
        div.style.width = size + "px";
        div.style.height = size + "px";
        div.style.left = (pixel.x - size / 2) + "px";
        div.style.top = (pixel.y - size / 2) + "px";
      };

      overlay.onRemove = function () {
        this.div.parentNode.removeChild(this.div);
        this.div = null;
      };

      overlay.updateSize = function (zoom) {
        const size = getSizeForZoom(zoom);
        if (this.div) {
          this.div.style.width = size + "px";
          this.div.style.height = size + "px";
        }
      };

      overlay.setMap(map);
      overlays.push(overlay);
    }

    //사이드바 토글
    document.getElementById("sidebar-toggle").addEventListener("click", () => {
  document.getElementById("sidebar").classList.toggle("open");
});

document.addEventListener("click", (e) => {
  const sidebar = document.getElementById("sidebar");
  const toggle = document.getElementById("sidebar-toggle");
  if (!sidebar.contains(e.target) && !toggle.contains(e.target)) {
    sidebar.classList.remove("open");
  }
});

//마커 추가 창 열기
const form = document.getElementById("marker-form");
let tempMarker = null;
let selectingPosition = false;

document.getElementById("add-marker-button").addEventListener("click", () => {
  form.classList.add("show");
});

document.addEventListener("click", (e) => {
  if (form.classList.contains("show") && !form.contains(e.target) && !e.target.closest("#add-marker-button") &&
    !e.target.closest("#confirm-location-btn") &&
    !e.target.closest("#cancel-location-btn")) {
      form.classList.remove("show");
    if (tempMarker) {
      tempMarker.setMap(null);
      tempMarker = null;
    }
  }
});

// 위치 설정하기 버튼 클릭 시
document.getElementById("select-location-btn").addEventListener("click", () => {
  form.classList.remove("show"); // 폼 숨기기
  selectingPosition = true;
  document.getElementById("location-confirm").style.display = "none";
});

// 지도에서 길게 누르기 이벤트 감지 (long press)
function setupLongPressListener() {
  let longPressTimeout = null;

  map.addListener("mousedown", (e) => {
    if (!selectingPosition) return;
    longPressTimeout = setTimeout(() => {
      if (tempMarker) tempMarker.setMap(null);

      tempMarker = new google.maps.Marker({
        position: e.latLng,
        map: map,
        icon: {
          url: "http://maps.google.com/mapfiles/ms/icons/red-dot.png"
        }
      });

      document.getElementById("location-action-buttons").style.display = "block";
    }, 600);
  });

  map.addListener("mouseup", () => {
    clearTimeout(longPressTimeout);
  });

  map.addListener("drag", () => {
    clearTimeout(longPressTimeout);
  });
}

//이미지 추가 시 썸네일 생성 & 대표 이미지 지정 기능 추가
const imageInput = document.getElementById("image");
const thumbnailsContainer = document.getElementById("thumbnails");
let imageFiles = [];
let coverIndex = 0;

imageInput.addEventListener("change", () => {
  thumbnailsContainer.innerHTML = ""; // 썸네일 초기화
  imageFiles = Array.from(imageInput.files);
  coverIndex = 0; // 기본 대표 이미지: 첫 번째

  imageFiles.forEach((file, index) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = document.createElement("img");
      img.src = e.target.result;
      img.style.width = "80px";
      img.style.height = "80px";
      img.style.objectFit = "cover";
      img.style.borderRadius = "8px";
      img.style.cursor = "pointer";
      img.style.border = index === 0 ? "3px solid #007bff" : "2px solid #ccc";

      img.addEventListener("click", () => {
        coverIndex = index;
        document.getElementById("coverIndex").value = index;
        // 모든 이미지 border 초기화
        Array.from(thumbnailsContainer.children).forEach(th => {
          th.style.border = "2px solid #ccc";
        });
        img.style.border = "3px solid #007bff"; // 선택된 이미지 강조
      });

      thumbnailsContainer.appendChild(img);
    };
    reader.readAsDataURL(file);
  });
});


// 확인 버튼: 좌표 입력 후 폼 복귀
document.getElementById("confirm-location-btn").addEventListener("click", () => {
  if (!tempMarker) return;

  const lat = tempMarker.getPosition().lat();
  const lng = tempMarker.getPosition().lng();

  document.getElementById("lat").value = lat;
  document.getElementById("lng").value = lng;

  form.classList.add("show");
  selectingPosition = false;
  document.getElementById("location-confirm").style.display = "block";
  document.getElementById("location-action-buttons").style.display = "none";
});

// 취소 버튼: 마커 제거 & 폼 복귀
document.getElementById("cancel-location-btn").addEventListener("click", () => {
  if (tempMarker) {
    tempMarker.setMap(null);
    tempMarker = null;
  }

  form.classList.add("show");
  selectingPosition = false;
  document.getElementById("location-confirm").style.display = "none";
  document.getElementById("location-action-buttons").style.display = "none";
});

//사이드바 닫기
document.addEventListener("click", (e) => {
  const sidebar = document.getElementById("sidebar");
  const toggle = document.getElementById("sidebar-toggle");
  if (!sidebar.contains(e.target) && !toggle.contains(e.target)) {
    sidebar.classList.remove("open");
  }
});

//이미지 리사이징(압축)
function resizeImage(file, maxWidth = 800, maxHeight = 800) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    const reader = new FileReader();

    reader.onload = function (e) {
      img.src = e.target.result;
    };

    img.onload = function () {
      const canvas = document.createElement("canvas");
      let width = img.width;
      let height = img.height;

      // 비율 유지하며 리사이징
      if (width > height) {
        if (width > maxWidth) {
          height *= maxWidth / width;
          width = maxWidth;
        }
      } else {
        if (height > maxHeight) {
          width *= maxHeight / height;
          height = maxHeight;
        }
      }

      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, width, height);

      canvas.toBlob((blob) => {
        resolve(blob); // 최종적으로 Blob 형태 반환
      }, "image/jpeg", 0.8); // 압축률 설정
    };

    reader.onerror = reject;
    img.onerror = reject;

    reader.readAsDataURL(file);
  });
}

    // 마커 추가
    document.getElementById("marker-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const title = document.getElementById("title").value;
      const lat = parseFloat(document.getElementById("lat").value);
      const lng = parseFloat(document.getElementById("lng").value);
      const date = document.getElementById("date").value;
      const coverIndex = parseInt(document.getElementById("coverIndex").value);
      const imageFiles = Array.from(document.getElementById("image").files);
      if (!imageFiles) {
        alert("사진을 선택해주세요.");
        return;
      }

      // 대표 이미지가 먼저 오도록 정렬
      const sortedFiles = [imageFiles[coverIndex], ...imageFiles.filter((_, i) => i !== coverIndex)];
      
      const storageRef = firebase.storage().ref();
      const imageUrls = [];

      for (const file of sortedFiles) {
        const resizedBlob = await resizeImage(file); // 리사이징 먼저
        const imageRef = storageRef.child("marker-images/" + Date.now() + "_" + file.name);
        const snapshot = await imageRef.put(resizedBlob); // 리사이즈된 blob 업로드
        const url = await snapshot.ref.getDownloadURL();
        imageUrls.push(url);
      }

      const newMarker = { date, title, lat, lng, imageUrls };
      db.ref("markers").push(newMarker);
      alert("마커가 추가되었습니다!");
      // 초기화
form.classList.remove("show");
form.reset();
if (tempMarker) {
  tempMarker.setMap(null);
  tempMarker = null;
}
selectingPosition = false;
location.reload();
    });
  </script>
</body>

</html>