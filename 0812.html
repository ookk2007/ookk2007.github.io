<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Google Maps + Firebase</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body {
  margin: 0;
  height: 100%;
}

#map {
  height: 100%;
  width: 100%;
  position: absolute;
}

#top-bar {
  position: absolute;
  top: 0;
  left: 0;
  height: 50px;
  width: 100%;
  background: rgba(255,255,255,0.95);
  display: flex;
  align-items: center;
  padding: 0 20px;
  z-index: 10;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

#sidebar {
  position: absolute;
  top: 50px;
  left: -300px;
  width: 300px;
  height: calc(100% - 50px);
  background: white;
  box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
  transition: left 0.3s;
  z-index: 11;
  overflow-y: auto;
  padding: 10px;
}

#sidebar.open {
  left: 0;
}

#marker-list {
  list-style: none;
  padding: 0;
}

#marker-list li {
  padding: 10px;
  border-bottom: 1px solid #eee;
  cursor: pointer;
}

#add-marker-button {
  margin-top: 10px;
  width: 100%;
  padding: 10px;
}


#top-bar button {
  margin-right: 15px;
  font-size: 24px;
  background: none;
  border: none;
  cursor: pointer;
}

#marker-form {
  position: absolute;
  top: 50%;
  left: 50%;
  width: 350px;
  transform: translate(-50%, -50%);
  background: white;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.2);
  z-index: 20;
  display: none;
}
#location-action-buttons {
  position: fixed;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%); /* 수평 가운데 정렬 */
  width: 100%;
  display: flex;
  justify-content: space-between; /* 버튼 간의 간격을 적당히 나눔 */
  z-index: 1000;
}

#location-action-buttons button {
  flex: 1;
  height: 60px;
  font-size: 18px;
  width: 49%;
  border: none;
  cursor: pointer;
}

#cancel-location-btn {
  background-color: #f44336;
  color: white;
}

#confirm-location-btn {
  background-color: #4CAF50;
  color: white;
}

    form {
      margin-top: 20px;
    }

    input,
    textarea {
      display: block;
      margin-bottom: 10px;
      width: 300px;
    }
  </style>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

</head>

<body>
   
  <div id="map"></div>
  <div id="top-bar">
    <button id="sidebar-toggle">☰</button>
    <span>Our Memorial Map</span>
  </div>
  <div id="sidebar">
    <ul id="marker-list"></ul>
    <button id="add-marker-button">마커 추가하기</button>
  </div>

  <form id="marker-form">
    <input type="text" id="title" placeholder="제목" required />
    <input type="date" id="date" required />
    <input type="number" id="lat" placeholder="위도" step="any" style="display:none;" required readonly />
    <input type="number" id="lng" placeholder="경도" step="any" style="display:none;" required readonly />
    <button type="button" id="select-location-btn">위치 설정하기</button>
    <input type="file" id="image" accept="image/*" multiple required />
    <button type="submit">마커 추가</button>
  </form>

  <div id="location-action-buttons" style="display: none;">
    <button id="confirm-location-btn">확인</button>
    <button id="cancel-location-btn">취소</button>
  </div>

  <!-- Google Maps API (아래 YOUR_API_KEY 부분을 발급받은 키로 교체) -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCqVKfR9xms-BS1q_knVrC1Iu3pFB42EB0&callback=initMap&libraries=geometry"
    async defer></script>

  <script>
    // Firebase 초기화
    const firebaseConfig = {
      apiKey: "AIzaSyAX6bguazAfd6OnKArF9dr7EGa-vxOri9A",
      authDomain: "hyeok-and-ryang.firebaseapp.com",
      databaseURL: "https://hyeok-and-ryang-default-rtdb.asia-southeast1.firebasedatabase.app/",
      projectId: "hyeok-and-ryang",
      storageBucket: "gs://hyeok-and-ryang.firebasestorage.app",
      messagingSenderId: "627188156266",
      appId: "1:627188156266:web:224812f4d3bfd0e2a78713"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const storage = firebase.storage();

    let map;
    const overlays = [];
    let infoWindow;

    // 지도 초기화 함수 (Google API가 자동으로 호출함)
    window.initMap = function () {
      infoWindow = new google.maps.InfoWindow();

      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 36.5, lng: 127.8 }, // 서울
        zoom: 7,
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: false,
        zoomControl: false,
        cameraControl: false,
        gestureHandling: "greedy"
      });

      loadMarkers();

      map.addListener("zoom_changed", () => {
        const currentZoom = map.getZoom();
        overlays.forEach(o => o.updateSize(currentZoom));
      });

      setupLongPressListener();
    };

    // Firebase에서 마커 불러오기
    function loadMarkers() {
  db.ref("markers").once("value", (snapshot) => {
    snapshot.forEach((child) => {
      const data = child.val();
      const key = child.key;
      addImageOverlay({ ...data, key });
      
      // 사이드바에 추가
      const li = document.createElement("li");
      li.textContent = `${data.date || "날짜 없음"} - ${data.title}`;
      li.addEventListener("click", () => {
        document.getElementById("sidebar").classList.remove("open");
        map.panTo(new google.maps.LatLng(data.lat, data.lng));
        infoWindow.close();
        infoWindow.setContent(`
          <h4>${data.title}</h4>
          ${(data.imageUrls || []).map(url => `<img src="${url}" style="width:100%; margin-top:5px;">`).join("")}
        `);
        infoWindow.setPosition(new google.maps.LatLng(data.lat, data.lng));
        infoWindow.open(map);
      });
      document.getElementById("marker-list").appendChild(li);
    });
  });
}


    //Zoom 레벨에 따른 마커 크기 계산
    function getSizeForZoom(zoom) {
      const baseSize = 60; // 기준 줌 레벨에서의 크기
      const baseZoom = 10;
      const scale = Math.pow(1.2, zoom - baseZoom);
      return Math.max(20, Math.min(100, baseSize * scale)); // 최소/최대 크기 제한
    }


    // 오버레이 생성 함수
    function addImageOverlay({ lat, lng, imageUrls, title }) {
      const div = document.createElement("div");
      
      div.addEventListener("click", () => {
        // 기존에 열린 infoWindow를 닫고 새로 열기
        infoWindow.close(); // 기존 infoWindow 닫기
        const imagesHtml = imageUrls.map(url => `
          <img src="${url}" style="width:100%; border-radius:8px; margin-bottom: 10px;" />
        `).join(""); // imageUrls 배열의 모든 이미지를 HTML로 변환하여 표시
        infoWindow.setContent(`
                  <div style="max-width:200px">
                  <h4>${title}</h4>
                  ${imagesHtml}
                  </div>
            `);
        infoWindow.setPosition(new google.maps.LatLng(lat, lng));
        infoWindow.open(map);
      });
      const overlay = new google.maps.OverlayView();

      overlay.onAdd = function () {
        div.style.position = "absolute";
        div.style.border = "2px solid white";
        div.style.borderRadius = "12px";
        div.style.boxShadow = "0 2px 6px rgba(0,0,0,0.3)";
        div.style.backgroundSize = "cover";
        div.style.backgroundImage = `url(${imageUrls})`;
        div.title = title;

        this.div = div;

        const panes = this.getPanes();
        panes.overlayImage.appendChild(div);
      };

      overlay.draw = function () {
        const projection = this.getProjection();
        const position = new google.maps.LatLng(lat, lng);
        const pixel = projection.fromLatLngToDivPixel(position);
        const zoom = map.getZoom();
        const size = getSizeForZoom(zoom);

        const div = this.div;
        div.style.width = size + "px";
        div.style.height = size + "px";
        div.style.left = (pixel.x - size / 2) + "px";
        div.style.top = (pixel.y - size / 2) + "px";
      };

      overlay.onRemove = function () {
        this.div.parentNode.removeChild(this.div);
        this.div = null;
      };

      overlay.updateSize = function (zoom) {
        const size = getSizeForZoom(zoom);
        if (this.div) {
          this.div.style.width = size + "px";
          this.div.style.height = size + "px";
        }
      };

      overlay.setMap(map);
      overlays.push(overlay);
    }

    //사이드바 토글
    document.getElementById("sidebar-toggle").addEventListener("click", () => {
  document.getElementById("sidebar").classList.toggle("open");
});

document.addEventListener("click", (e) => {
  const sidebar = document.getElementById("sidebar");
  const toggle = document.getElementById("sidebar-toggle");
  if (!sidebar.contains(e.target) && !toggle.contains(e.target)) {
    sidebar.classList.remove("open");
  }
});

//마커 추가 창 열기
const form = document.getElementById("marker-form");
let tempMarker = null;
let selectingPosition = false;

document.getElementById("add-marker-button").addEventListener("click", () => {
  form.style.display = "block";
});

document.addEventListener("click", (e) => {
  if (form.style.display === "block" && !form.contains(e.target) && !e.target.closest("#add-marker-button") &&
    !e.target.closest("#confirm-location-btn") &&
    !e.target.closest("#cancel-location-btn")) {
    form.style.display = "none";
  }
});

// 위치 설정하기 버튼 클릭 시
document.getElementById("select-location-btn").addEventListener("click", () => {
  form.style.display = "none"; // 폼 숨기기
  selectingPosition = true;
});

// 지도에서 길게 누르기 이벤트 감지 (long press)
function setupLongPressListener() {
  let longPressTimeout = null;

  map.addListener("mousedown", (e) => {
    if (!selectingPosition) return;
    longPressTimeout = setTimeout(() => {
      if (tempMarker) tempMarker.setMap(null);

      tempMarker = new google.maps.Marker({
        position: e.latLng,
        map: map,
        icon: {
          url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
        }
      });

      document.getElementById("location-action-buttons").style.display = "block";
    }, 600);
  });

  map.addListener("mouseup", () => {
    clearTimeout(longPressTimeout);
  });

  map.addListener("drag", () => {
    clearTimeout(longPressTimeout);
  });
}

// 확인 버튼: 좌표 입력 후 폼 복귀
document.getElementById("confirm-location-btn").addEventListener("click", () => {
  if (!tempMarker) return;

  const lat = tempMarker.getPosition().lat();
  const lng = tempMarker.getPosition().lng();

  document.getElementById("lat").value = lat;
  document.getElementById("lng").value = lng;

  form.style.display = "block";
  selectingPosition = false;
  document.getElementById("location-action-buttons").style.display = "none";
});

// 취소 버튼: 마커 제거 & 폼 복귀
document.getElementById("cancel-location-btn").addEventListener("click", () => {
  if (tempMarker) {
    tempMarker.setMap(null);
    tempMarker = null;
  }

  form.style.display = "block";
  selectingPosition = false;
  document.getElementById("location-action-buttons").style.display = "none";
});

//사이드바 닫기
document.addEventListener("click", (e) => {
  const sidebar = document.getElementById("sidebar");
  const toggle = document.getElementById("sidebar-toggle");
  if (!sidebar.contains(e.target) && !toggle.contains(e.target)) {
    sidebar.classList.remove("open");
  }
});



    // 마커 추가
    document.getElementById("marker-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const title = document.getElementById("title").value;
      const lat = parseFloat(document.getElementById("lat").value);
      const lng = parseFloat(document.getElementById("lng").value);
      const date = document.getElementById("date").value;
      const imageFiles = document.getElementById("image").files;

      if (!imageFiles) {
        alert("사진을 선택해주세요.");
        return;
      }
      const storageRef = firebase.storage().ref();
      const imageUrls = [];

      for (const file of imageFiles) {
        const imageRef = storageRef.child("marker-images/" + Date.now() + "_" + file.name);
        const snapshot = await imageRef.put(file);
        const url = await snapshot.ref.getDownloadURL();
        imageUrls.push(url);
      }

      const newMarker = { date, title, lat, lng, imageUrls };
      db.ref("markers").push(newMarker);
      alert("마커가 추가되었습니다!");
      // 초기화
form.style.display = "none";
form.reset();
if (tempMarker) {
  tempMarker.setMap(null);
  tempMarker = null;
}
selectingPosition = false;
location.reload();
    });
  </script>
</body>

</html>